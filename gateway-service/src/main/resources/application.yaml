server:
  port: 8080
  servlet:
    session:
      cookie:
        name: GATEWAY_SESSION
        http-only: true
        secure: false  # Set to true in production with HTTPS
        same-site: lax
        max-age: 3600

spring:
  application:
    name: Gateway Service

  data:
    redis:
      host: localhost
      port: 6379
      password: # Set if Redis has password
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms
        shutdown-timeout: 100ms

  # Session Configuration with Redis
  session:
    store-type: redis
    redis:
      namespace: spring:session:gateway
      flush-mode: on_save
      cleanup-cron: "0 * * * * *"  # Cleanup expired sessions every minute
    timeout: 3600s  # 1 hour session timeout

  # OAuth2 Client Configuration
  security:
    oauth2:
      client:
        registration:
          keycloak:
            client-id: gateway-client
            # No client-secret needed for PKCE public client
            client-authentication-method: none
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            scope:
              - openid
              - profile
              - email
            client-name: Keycloak
        provider:
          keycloak:
            issuer-uri: http://localhost:8180/realms/my-realm
            authorization-uri: http://localhost:8180/realms/my-realm/protocol/openid-connect/auth
            token-uri: http://localhost:8180/realms/my-realm/protocol/openid-connect/token
            user-info-uri: http://localhost:8180/realms/my-realm/protocol/openid-connect/userinfo
            jwk-set-uri: http://localhost:8180/realms/my-realm/protocol/openid-connect/certs
            user-name-attribute: preferred_username
  cloud:
    gateway:
      server:
        webflux:
          routes:
            - id: auth-test-service
              uri: http://localhost:8081
              predicates:
                - Path=/test/**
              filters:
                - TokenRelay=
                - StripPrefix=1

# Actuator endpoints
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,sessions
  endpoint:
    health:
      show-details: always

# Logging
logging:
  level:
    root: INFO
    org.springframework.security: DEBUG
    org.springframework.session: DEBUG
    org.springframework.data.redis: DEBUG
    org.springframework.cloud.gateway: DEBUG